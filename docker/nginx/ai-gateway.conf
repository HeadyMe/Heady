# Heady AI Gateway - Nginx configuration
# Routes requests to the correct AI model service

upstream ollama_main {
    server ollama:11434;
    keepalive 32;
}

upstream ollama_llama {
    server llama-service:11434;
    keepalive 16;
}

upstream ollama_code {
    server code-service:11434;
    keepalive 16;
}

upstream ollama_embed {
    server embedding-service:11434;
    keepalive 16;
}

upstream ollama_vision {
    server vision-service:11434;
    keepalive 8;
}

upstream huggingface {
    server huggingface-tgi:80;
    keepalive 8;
}

upstream whisper {
    server whisper-service:9000;
    keepalive 8;
}

upstream tts {
    server tts-service:10200;
    keepalive 8;
}

upstream qdrant {
    server qdrant-ai:6333;
    keepalive 8;
}

server {
    listen 80;
    server_name _;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 '{"status":"ok","service":"heady-ai-gateway"}';
        add_header Content-Type application/json;
    }

    # Default Ollama (main)
    location /api/ {
        proxy_pass http://ollama_main/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
    }

    # Llama text generation
    location /llama/ {
        proxy_pass http://ollama_llama/;
        proxy_set_header Host $host;
        proxy_read_timeout 300s;
    }

    # Code generation
    location /code/ {
        proxy_pass http://ollama_code/;
        proxy_set_header Host $host;
        proxy_read_timeout 300s;
    }

    # Embeddings
    location /embed/ {
        proxy_pass http://ollama_embed/;
        proxy_set_header Host $host;
        proxy_read_timeout 120s;
    }

    # Vision models
    location /vision/ {
        proxy_pass http://ollama_vision/;
        proxy_set_header Host $host;
        proxy_read_timeout 300s;
    }

    # HuggingFace TGI
    location /hf/ {
        proxy_pass http://huggingface/;
        proxy_set_header Host $host;
        proxy_read_timeout 300s;
    }

    # Whisper ASR
    location /whisper/ {
        proxy_pass http://whisper/;
        proxy_set_header Host $host;
        proxy_read_timeout 120s;
        client_max_body_size 50M;
    }

    # TTS
    location /tts/ {
        proxy_pass http://tts/;
        proxy_set_header Host $host;
        proxy_read_timeout 60s;
    }

    # Qdrant vector DB
    location /vectors/ {
        proxy_pass http://qdrant/;
        proxy_set_header Host $host;
        proxy_read_timeout 60s;
    }
}
